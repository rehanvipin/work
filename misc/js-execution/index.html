<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.131.0">
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="How does JS run in the browser &amp; node? # If you prefer visuals over text, these talks are really good (videos aren&rsquo;t mine):
WTH is the Event Loop? Further Adventures of the Event Loop Jake Archibald on the Event Loop Overview # The v8 runtime provides a call stack and heap. Then in the browser, we have the WebAPIs, which provides FUNctions which can make code execute elsewhere. We have :">
<meta name="theme-color" content="#FFFFFF"><meta property="og:url" content="https://work.rehanvipin.me/misc/js-execution/">
  <meta property="og:site_name" content="Field Manual">
  <meta property="og:title" content="JavaScript execution">
  <meta property="og:description" content="How does JS run in the browser &amp; node? # If you prefer visuals over text, these talks are really good (videos arenâ€™t mine):
WTH is the Event Loop? Further Adventures of the Event Loop Jake Archibald on the Event Loop Overview # The v8 runtime provides a call stack and heap. Then in the browser, we have the WebAPIs, which provides FUNctions which can make code execute elsewhere. We have :">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="misc">
<title>JavaScript execution | Field Manual</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.ece3f56fc3f716f87ccd4e6f3ea44ba1fa6757114261dadfbf861fde7d4e6203.css" integrity="sha256-7OP1b8P3Fvh8zU5vPqRLofpnVxFCYdrfv4Yf3n1OYgM=">
<script defer src="/en.search.min.980501639517bbd4701a880feac02cba72d2653ca7c0c6e45d900b4749d7c2da.js" integrity="sha256-mAUBY5UXu9RwGogP6sAsunLSZTynwMbkXZALR0nXwto="></script>

<script defer src="/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js" integrity="sha256-b2&#43;Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC&#43;NdcPIvZhzk="></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/"><img src="/favicon.png" alt="Logo" /><span>Field Manual</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>











  



  
  <ul>
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-db70775a2f464f55832baa63954506fc" class="toggle"  />
    <label for="section-db70775a2f464f55832baa63954506fc" class="flex justify-between">
      <a href="https://work.rehanvipin.me/angular/" class="">Angular</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/overview/" class="">Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/components/" class="">Components</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/template/" class="">Template Syntax</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/services/" class="">Services</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/directives/" class="">Directives</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/routing/" class="">Routing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/forms/" class="">Forms</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/pipes/" class="">Pipes</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/di/" class="">Dependency Injection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/rxjs/" class="">RxJS</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/test/" class="">Testing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/libraries/" class="">Libraries</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/angular/signals/" class="">Reactivity with Signals</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-044fa29ae89cdc7fefbeda99f0fc5d1f" class="toggle"  />
    <label for="section-044fa29ae89cdc7fefbeda99f0fc5d1f" class="flex justify-between">
      <a href="https://work.rehanvipin.me/spring-boot/" class="">Spring Boot</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/spring-boot/framework/" class="">Spring Framework</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/spring-boot/gradle/" class="">Gradle</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-a533dae2ec66f5b51d3c38ec9d934c01" class="toggle"  />
    <label for="section-a533dae2ec66f5b51d3c38ec9d934c01" class="flex justify-between">
      <a href="https://work.rehanvipin.me/java/" class="">Java</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/java/intro/" class="">Setup</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/java/modules/" class="">Mods &amp; Packs</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/java/jvm/" class="">JVM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/java/build_tools/" class="">Build tools</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/java/web-server/" class="">Web Server</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <input type="checkbox" id="section-9e5aaccdf48687824ccd3b3097af8e41" class="toggle"  />
    <label for="section-9e5aaccdf48687824ccd3b3097af8e41" class="flex justify-between">
      <a href="https://work.rehanvipin.me/linux/" class="">Linux stuff</a>
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li class="book-section-flat" >
          
  
  

  
    <span>Fun Stuff</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/d3/" class="">D3</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/typescript/" class="">Typescript</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/tips-tricks/" class="">Tips &amp; Tricks</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/js-execution/" class=" active">JavaScript execution</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/web-app-arch/" class="">Web App Architecture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/misc/web-auth/" class="">Web Authentication</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/tmp/" class="">/tmp</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/whatnext/" class="">/next</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://work.rehanvipin.me/credits/" class="">/credits</a>
  

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>JavaScript execution</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#how-does-js-run-in-the-browser--node">How does JS run in the browser &amp; node?</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#event-loop">Event loop</a></li>
        <li><a href="#task-queues">Task Queues</a></li>
        <li><a href="#microtask-queues">Microtask Queues</a></li>
        <li><a href="#rendering-pipeline">Rendering pipeline</a></li>
        <li><a href="#web-workers">Web Workers</a></li>
        <li><a href="#events">Events</a></li>
        <li><a href="#generators">Generators</a></li>
        <li><a href="#execution-flow-">Execution flow :</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="how-does-js-run-in-the-browser--node">
  How does JS run in the browser &amp; node?
  <a class="anchor" href="#how-does-js-run-in-the-browser--node">#</a>
</h1>
<p>If you prefer visuals over text, these talks are really good (videos aren&rsquo;t mine):</p>
<ul>
<li>
  <a href="https://www.youtube.com/watch?v=8aGhZQkoFbQ">WTH is the Event Loop?</a></li>
<li>
  <a href="https://www.youtube.com/watch?v=u1kqx6AenYw">Further Adventures of the Event Loop</a></li>
<li>
  <a href="https://www.youtube.com/watch?v=cCOL7MC4Pl0">Jake Archibald on the Event Loop</a></li>
</ul>
<h2 id="overview">
  Overview
  <a class="anchor" href="#overview">#</a>
</h2>
<p>The v8 runtime provides a <strong>call stack</strong> and heap.
Then in the browser, we have the WebAPIs, which provides FUNctions which can make code execute elsewhere.
We have :</p>
<ul>
<li>Task queues (sometimes called Macrotask queues)</li>
<li>Microtask queues</li>
<li>Rendering pipeline</li>
</ul>
<p>All these are enough for async single-thread execution of JS.</p>
<p>To do parallel exec, the browser provides Web Workers. Those have their own task &amp; microtask queues.
However, they can&rsquo;t maniupilate the DOM and they don&rsquo;t have any rendering pipelines.
The single rendering pipeline runs in the main thread.</p>
<p>In the case of Node, it has similar task &amp; microtask queues,
but bit different kinds than those in the browser.</p>
<p>Fun fact, after going through the talks, it should make sense why this code will never cause <code>el</code> to appear on the screen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>document.<span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">append</span>(<span style="color:#a6e22e">el</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">el</span>.<span style="color:#a6e22e">style</span>.<span style="color:#a6e22e">display</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;none&#39;</span>;
</span></span></code></pre></div><p>Think you know it all? Good for you. Test out your skills 
  <a href="https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/#level-1-bossfight">with these questions</a>.</p>
<h2 id="event-loop">
  Event loop
  <a class="anchor" href="#event-loop">#</a>
</h2>
<p>The event loop is a piece of code in the browser (and nodeJS as well, but it&rsquo;s bit different in node),
that looks for something to execute from the queues (it has a priority order to decide which queue) and then puts that
on the call stack.</p>
<p>It doesn&rsquo;t do anything as long as there is something executing in the call stack.
It will wait for all that to be done before picking up the next task (yes, even page repaint is a task)</p>
<h2 id="task-queues">
  Task Queues
  <a class="anchor" href="#task-queues">#</a>
</h2>
<p>Wait what? There should be only one right? Haha, no.
There can be one for network events (fetch), setTimeouts and other use a different one. That&rsquo;s why fetch completes before setTimeout
even if setTimeout may queue the task first.
Calling setTimeout won&rsquo;t queue a task, it will do it after its waiting time.</p>
<h2 id="microtask-queues">
  Microtask Queues
  <a class="anchor" href="#microtask-queues">#</a>
</h2>
<p>Tasks from this queue are executed immediately when the call stack is empty.
Thus, these can be executed even in the middle of a regular task (NOT WHEN JS CODE IS EXECUTING ON THE STACK).
Whaaat? it&rsquo;s possible that a task is executing without JS code? Yeah.
Imagine an event, after each node that it bubbles on and executes listener callbacks, there is no code on the call stack,
but since it is still bubbling, the task itself is not done.
Hence, microtasks can execute in between this task, but regular tasks will have to wait for all the bubbling etc to be complete.</p>
<p>When the event loop picks up microtasks, it drains the queue till is empty.
What action puts tasks in the microtask queue? Promises and Mutation Observers.</p>
<p>Fun fact, the browser doesn&rsquo;t add a new mutation observer task on the same element-attribute combo if one is already pending in the queue.</p>
<h2 id="rendering-pipeline">
  Rendering pipeline
  <a class="anchor" href="#rendering-pipeline">#</a>
</h2>
<p>The browser provides us a way to add tasks to the rendering pipeline, through a &ldquo;rendering queue&rdquo;.
When the event loop starts processing this queue, it drains the queue till all existing tasks of the queue are processed.
How to add things to this queue? <code>requestAnimationFrame(callback)</code>.
The rendering pipeline consists of first executing tasks from rendering queue and then performing CSS calculations and painting.
The event loop looks at this queue every 16 ms (if it&rsquo;s a 60Hz screen), unless it&rsquo;s in the background.
Remember, the event loop cannot look at this queue if there is something being executed on the call stack.
Also, it will check the microtask queue first, before looking at this queue.</p>
<h2 id="web-workers">
  Web Workers
  <a class="anchor" href="#web-workers">#</a>
</h2>
<p>Web workers and cross-origin iframes are said to have their own runtimes.
Meaning, they will have their own queues, stacks, and heaps.
Runtimes can communicate using the <code>postMessage</code> function.</p>
<h2 id="events">
  Events
  <a class="anchor" href="#events">#</a>
</h2>
<p>Well, it&rsquo;s called the <em>event</em> loop after all. So when do browser events such as clicking a button get executed?
What if the button is programatically clicked through JS?</p>
<p>The click event (as an example) causes the browser&rsquo;s event processing task to be added to the queue.
When that task is picked up by the loop, it goes through the DOM tree
and executes all the event listener callback functions on the element it encounters.</p>
<p>If the click event task is programatically called (e.g., <code>el.click()</code>), all the callbacks are added to the call stack.
All the event listener callbacks can be synchronously added to the call stack via <code>dispatchEvent(event: Event)</code>.
Events dispatched programatically also follow all the regular bubbling and capturing rules.</p>
<p>When adding multiple callbacks via addEventListener, it&rsquo;s not guaranteed which one will be added the queue first.</p>
<h2 id="generators">
  Generators
  <a class="anchor" href="#generators">#</a>
</h2>
<p>These are similar to Python generators. You can define one like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">ayo</span>(<span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> <span style="color:#e6db74">&#39;x&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> <span style="color:#e6db74">&#39;y&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">yield</span> <span style="color:#e6db74">&#39;z&#39;</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">genr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ayo</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">genr</span>.<span style="color:#a6e22e">next</span>()); <span style="color:#75715e">// {value: &#39;x&#39;; done: false;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">genr</span>.<span style="color:#a6e22e">next</span>()); <span style="color:#75715e">// {value: &#39;y&#39;; done: false;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">genr</span>.<span style="color:#a6e22e">next</span>()); <span style="color:#75715e">// {value: &#39;z&#39;; done: false;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">genr</span>.<span style="color:#a6e22e">next</span>()); <span style="color:#75715e">// {value: undefined; done: true;}
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">othergen</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ayo</span>(<span style="color:#e6db74">&#39;hey there&#39;</span>);
</span></span></code></pre></div><p>like an array, you can iterate over them.</p>
<p>TODO : Learn more about them here : 
  <a href="https://javascript.info/generators">https://javascript.info/generators</a></p>
<h2 id="execution-flow-">
  Execution flow :
  <a class="anchor" href="#execution-flow-">#</a>
</h2>
<p>JS is an interpreted language. Here is how the JS execution engine in the browser
handles it.</p>
<ol>
<li>Parse a line</li>
<li>Compile</li>
<li>Optimize</li>
<li>Execute</li>
<li>Garbage Collection</li>
</ol>
<p>However, to make if faster, there is a Just-In-Time compiler,
which is done by monitoring the code for hot-spots (e.g., code run frequently) and
then compiling / compiling with optimizations so machine code is available fast.</p>
<p>WebAssembly is faster because it is precompiled and optimized for the architecture.
Often the machine code it produces is more optimized than the one JS engine produces.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
      </footer>

      
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#how-does-js-run-in-the-browser--node">How does JS run in the browser &amp; node?</a>
      <ul>
        <li><a href="#overview">Overview</a></li>
        <li><a href="#event-loop">Event loop</a></li>
        <li><a href="#task-queues">Task Queues</a></li>
        <li><a href="#microtask-queues">Microtask Queues</a></li>
        <li><a href="#rendering-pipeline">Rendering pipeline</a></li>
        <li><a href="#web-workers">Web Workers</a></li>
        <li><a href="#events">Events</a></li>
        <li><a href="#generators">Generators</a></li>
        <li><a href="#execution-flow-">Execution flow :</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












